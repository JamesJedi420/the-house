<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fixing Up a House — Beat 1 Prototype</title>
  <style>
    :root{--bg:#0b0c10;--panel:#12141b;--ink:#e8e8ea;--muted:#b4b7c2;--accent:#7aa2ff;--line:#222635;--mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--sans:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:var(--sans);line-height:1.35}
    .wrap{max-width:1100px;margin:0 auto;padding:18px;display:grid;gap:14px;grid-template-columns:1.35fr .65fr}
    header{grid-column:1/-1;display:flex;align-items:flex-end;justify-content:space-between;gap:10px}
    h1{font-size:18px;margin:0;font-weight:650}
    .sub{font-size:12px;color:var(--muted)}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .main{display:flex;flex-direction:column;min-height:70vh}
    .bar{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
    .bar .left{display:flex;gap:10px;align-items:center}
    .pill{font-family:var(--mono);font-size:12px;color:var(--muted);border:1px solid var(--line);padding:6px 9px;border-radius:999px}
    .btn{cursor:pointer;background:transparent;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:8px 10px;font-size:12px}
    .btn:hover{border-color:#2f3550}
    .btn.primary{border-color:rgba(122,162,255,.55);background:rgba(122,162,255,.08)}
    .btn.danger{border-color:rgba(255,107,107,.55);background:rgba(255,107,107,.08)}
    .content{padding:14px;display:flex;flex-direction:column;gap:12px}
    .title{font-size:14px;font-weight:650;margin:0}
    .text{font-size:14px}
    .text p{margin:0 0 10px 0}
    .text p:last-child{margin:0}
    .thoughts{margin-top:10px;border-left:3px solid rgba(122,162,255,.5);padding-left:10px;color:var(--muted);font-style:italic}
    .choices{margin-top:auto;border-top:1px solid var(--line);padding:12px 14px;display:flex;flex-direction:column;gap:10px}
    .choiceRow{display:flex;flex-wrap:wrap;gap:10px}
    .choice{flex:1;min-width:210px;text-align:left}
    .side{display:flex;flex-direction:column;gap:14px}
    .side .section{padding:12px 14px;border-bottom:1px solid var(--line)}
    .side .section:last-child{border-bottom:none}
    .side h2{font-size:13px;margin:0 0 10px 0;font-weight:650}
    .kv{display:flex;justify-content:space-between;gap:10px;font-size:12px;color:var(--muted);margin:6px 0}
    .kv b{color:var(--ink);font-weight:650}
    .list{display:flex;flex-wrap:wrap;gap:8px}
    .tag{font-family:var(--mono);font-size:12px;border:1px solid var(--line);color:var(--muted);padding:6px 8px;border-radius:999px}
    .tag.ok{border-color:rgba(107,255,179,.55);background:rgba(107,255,179,.06)}
    .journal{font-size:12px;color:var(--muted)}
    .journal .item{padding:8px 10px;border:1px solid var(--line);border-radius:12px;margin:8px 0;background:rgba(255,255,255,.02)}
    .small{font-size:12px;color:var(--muted)}
    @media (max-width:920px){.wrap{grid-template-columns:1fr}.main{min-height:62vh}}
    #metaRow{justify-content:flex-end}
  </style>
</head>
<body>
  <header class="wrap" style="padding-bottom:0">
    <div>
      <h1>Fixing Up a House — Beat 1 Prototype</h1>
      <div class="sub">Playable beats 1.1 through 1.8. Toggle actor notes. Track props and clues.</div>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
      <button class="btn primary" id="btnNew">New run</button>
      <button class="btn" id="btnSave">Save</button>
      <button class="btn" id="btnLoad">Load</button>
      <button class="btn danger" id="btnReset">Reset save</button>
    </div>
  </header>

  <div class="wrap">
    <section class="panel main" aria-label="Story panel">
      <div class="bar">
        <div class="left">
          <span class="pill" id="beatPill">Beat 1.1</span>
          <span class="pill" id="locPill">Backroad</span>
        </div>
        <div class="left">
          <button class="btn" id="btnToggleNotes">Actor notes: off</button>
          <button class="btn" id="btnToggleType">Typewriter: on</button>
        </div>
      </div>

      <div class="content">
        <h2 class="title" id="sceneTitle">Loading…</h2>
        <div class="text" id="sceneText" aria-live="polite"></div>
        <div class="small" id="hintText"></div>
      </div>

      <div class="choices" aria-label="Choices">
        <div class="choiceRow" id="choiceRow"></div>

        <div class="choiceRow" id="metaRow" aria-label="End of beat actions">
          <button class="btn" id="btnBeatReplay">Replay</button>
          <button class="btn danger" id="btnBeatSaveStop">Save and stop</button>
        </div>
      </div>
    </section>

    <aside class="panel side" aria-label="Status panel">
      <div class="section">
        <h2>Status</h2>
        <div class="kv"><span>Trust</span><b id="trustVal">0</b></div>
        <div class="kv"><span>Normalcy</span><b id="normVal">0</b></div>
        <div class="kv"><span>Unease</span><b id="uneaseVal">0</b></div>
        <div class="kv"><span>Time</span><b id="timeVal">Late afternoon</b></div>
      </div>

      <div class="section">
        <h2>Inventory</h2>
        <div class="list" id="invList"></div>
        <div class="small">Props appear as you discover them.</div>
      </div>

      <div class="section">
        <h2>Clues</h2>
        <div class="journal" id="journal"></div>
      </div>
    </aside>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const state = {
    beat: "1.1",
    showNotes: false,
    typewriter: true,
    trust: 0,
    normalcy: 0,
    unease: 0,
    time: "Late afternoon",
    inv: new Set(),
    clues: [],
    flags: {
      gotPliers: true,
      breakerReset: false,
      code8139: false,
      gotBoltCutters: false,
      gotBucket: false,
      gotWellKey: false,
      gotRadio: false,
      deliveredWater: false
    }
  };

  const beats = {
    "1.1": {
      title: "Backroad approach",
      loc: "Car, backroad",
      time: "Late afternoon",
      text: [
        "The backroad is quiet. Dry brush and pale grass pass in repeating patterns outside the windows.",
        "Amanda drives. Ashley sits in the passenger seat with a compact mirror in her palm.",
        "A van follows at a steady distance in the rearview mirror.",
        "The road crests. A dirt drive branches off. Past a clearing, a two story house comes into view.",
        "A porch light is on in daylight. Curtains are drawn with thin gaps leaking light."
      ],
      notes: [
        "[AMANDA: Keep it friendly. Store details. Do not correct anyone out loud yet.]",
        "[ASHLEY: Treat the light as welcome. Stay pleasant. Do not be the first to say it feels wrong.]"
      ],
      choices: [
        { t: "Say nothing. Turn onto the dirt drive.", next: "1.2", fx: (s)=>{ s.unease += 1; } },
        { t: "Joke to Ashley about Scott’s planning.", next: "1.2", fx: (s)=>{ s.trust += 1; s.normalcy += 1; } }
      ],
      hint: "Your tone sets the baseline."
    },
    "1.2": {
      title: "Arrival and unloading",
      loc: "Clearing and porch",
      time: "Late afternoon",
      text: [
        "The car rolls into a packed dirt clearing. Gravel crunches under the tires. Dust rises and settles slowly.",
        "Scott arrives behind you and lifts the tailgate. Boxes are stacked tight. Twine knots are quick and utilitarian.",
        "Brian’s engine sound is faint in the distance, then closer, then fades again behind dust."
      ],
      notes: [
        "[AMANDA: Keep a clear lane to the door. Make Scott carry something heavy.]"
      ],
      choices: [
        { t: "Stage boxes on the porch.", next: "1.3", fx: (s)=>{ s.normalcy += 1; s.trust += 1; } },
        { t: "Wait for Brian before entering.", next: "1.3", fx: (s)=>{ s.unease += 1; s.trust += 1; } }
      ],
      hint: "The porch becomes a landmark."
    },
    "1.3": {
      title: "Brian arrives. First entry.",
      loc: "Porch and entry",
      time: "Late afternoon",
      text: [
        "Brian’s sedan breaks through the dust and stops angled slightly off straight.",
        "Scott opens the front door with a worn brass key. The air inside smells of old wood and faint cleaner.",
        "The entry table holds a flashlight placed parallel to the table edge. A coil of rope sits on a nearby box."
      ],
      notes: [
        "[AMANDA: Map the space. Do not touch the flashlight yet.]"
      ],
      choices: [
        { t: "Follow the backpacks upstairs instruction.", next: "1.4", fx: (s)=>{ s.normalcy += 1; s.trust += 1; } },
        { t: "Pause and scan the hall and stairs.", next: "1.4", fx: (s)=>{ s.unease += 1; s.trust += 1; } }
      ],
      hint: "The entry table repeats."
    },
    "1.4": {
      title: "Rooms claimed. Task assigned.",
      loc: "Upstairs then living room",
      time: "Late afternoon",
      text: [
        "Upstairs, backpacks land in the first room on the left.",
        "Brian claims the room with the window that opens. Ashley notices old stains on her mattress.",
        "Back downstairs, Scott cannot find the tape deck and asks Amanda to search."
      ],
      notes: [
        "[AMANDA: Say yes without becoming staff. Demand a trade.]"
      ],
      choices: [
        { t: "Take the key and tell Scott to carry heavy boxes while you search.", next: "1.5", fx: (s)=>{ s.trust += 1; s.normalcy += 1; } },
        { t: "Take the key and leave without comment.", next: "1.5", fx: (s)=>{ s.unease += 1; } }
      ],
      hint: "Delegation changes relationships."
    },
    "1.5": {
      title: "Study tableau. First denied door.",
      loc: "Kitchen hall and study",
      time: "Late afternoon",
      text: [
        "The kitchen hall is narrow. The breaker cover is labeled: KITCHEN, HALL, PORCH LIGHT, UPSTAIRS.",
        "The study is staged: blank notepad aligned, pen aligned, lamp unplugged with cord coiled.",
        "A folder holds a 1942 discharge notice with formal language.",
        "The utility closet knob turns slightly, then stops. The storage room lock refuses the key."
      ],
      notes: [
        "[AMANDA: The neatness feels authored. Keep that private evidence.]"
      ],
      choices: [
        { t: "Return and demand the correct key.", next: "1.6", fx: (s)=>{ s.trust += 1; s.unease += 1; s.clues.push({k:'1942 letter', v:'A discharge notice is filed in the study.'}); } },
        { t: "Waste time trying doors again.", next: "1.6", fx: (s)=>{ s.unease += 2; s.clues.push({k:'1942 letter', v:'A discharge notice is filed in the study.'}); } }
      ],
      hint: "Prepared rooms suggest intent."
    },
    "1.6": {
      title: "Storage, breaker, tape deck",
      loc: "Storage room and kitchen",
      time: "Late afternoon",
      text: [
        "Scott hands over a cleaner silver key.",
        "The storage room opens. Boxes are labeled TOOLS, WATER, LIGHTS. A tote labeled MUSIC sits on a lower shelf.",
        "Inside: a tape deck and speakers. The power cord has a taped splice.",
        "At the kitchen counter, the outlet is dead. Amanda flips the labeled breaker. The tape deck powers on."
      ],
      notes: ["[AMANDA: Fix one thing. Make Scott work while you solve it.]"],
      choices: [
        { t: "Return the tape deck and keep Scott carrying boxes.", next: "1.7", fx: (s)=>{ s.normalcy += 1; s.flags.breakerReset = true; s.inv.add('Tape deck'); s.inv.add('Speakers'); } },
        { t: "Ignore boxes and focus on testing sound.", next: "1.7", fx: (s)=>{ s.unease += 1; s.flags.breakerReset = true; s.inv.add('Tape deck'); s.inv.add('Speakers'); } }
      ],
      hint: "Working sound stabilizes the group."
    },
    "1.7": {
      title: "No water. Yard loop.",
      loc: "Kitchen to shed",
      time: "Late afternoon",
      text: [
        "The faucet gives an empty sound. No drip. No sputter.",
        "Amanda exits to the side yard. The shed is tied shut with rope.",
        "A cage sits half hidden in brush. Pliers open it. A damp note shows 8139.",
        "A lockbox opens. Bolt cutters snap the rope. The shed holds a bucket and a folded 1944 clipping."
      ],
      notes: ["[AMANDA: You are doing labor to keep the group intact.]"],
      choices: [
        { t: "Take the bucket. Head uphill to the well.", next: "1.8", fx: (s)=>{ s.flags.code8139=true; s.flags.gotBoltCutters=true; s.flags.gotBucket=true; s.inv.add('Pliers'); s.inv.add('Bolt cutters'); s.inv.add('Bucket'); s.clues.push({k:'8139', v:'Code from the cage note.'}); s.clues.push({k:'1944 clipping', v:'A missing teen story folded in the shed.'}); } },
        { t: "Bring the bucket back first. Risk delay.", next: "1.8", fx: (s)=>{ s.flags.code8139=true; s.flags.gotBoltCutters=true; s.flags.gotBucket=true; s.unease += 1; s.inv.add('Pliers'); s.inv.add('Bolt cutters'); s.inv.add('Bucket'); s.clues.push({k:'8139', v:'Code from the cage note.'}); s.clues.push({k:'1944 clipping', v:'A missing teen story folded in the shed.'}); } }
      ],
      hint: "Outside is exposed."
    },
    "1.8": {
      title: "Well key. Radio payoff.",
      loc: "Well to house",
      time: "Dusk",
      text: [
        "The bucket comes up with cold water and a small old key.",
        "At the tree line, a human silhouette stands between trunks, then is gone without sound.",
        "Back in the kitchen, water is poured into a glass.",
        "The old key opens the under-stairs closet. Inside: a portable radio, fresh batteries, and an unlabeled cassette.",
        "The radio powers on. Static dominates. A voice fragment breaks through for a second, then drops out again."
      ],
      notes: ["[AMANDA: Deliver function first. Do not announce the watcher yet.]"],
      choices: [
        { t: "Continue.", next: "2.1", fx: (s)=>{ 
            s.flags.gotWellKey=true; 
            s.flags.gotRadio=true; 
            s.flags.deliveredWater=true; 
            s.inv.add('Well key'); 
            s.inv.add('Radio'); 
            s.inv.add('AA batteries'); 
            s.inv.add('Cassette (unlabeled)'); 
            s.clues.push({k:'Watcher', v:'A silhouette at the tree line near the well.'}); 
          } 
        },
        { t: "Replay from Beat 1.1.", next: "1.1", fx: (s)=>{} }
      ],
      hint: "Beat 1 ends with unstable sound."
    },

    "2.1": {
      title: "Inventory and the decision",
      loc: "Living room",
      time: "Dusk",
      text: [
        "The radio hisses with static near the front window. The tape deck power light stays on, but the room still feels quiet between bursts of noise.",
        "Boxes are half-open. Packing paper is piled near the couch. Dust has settled into the corners of the entryway.",
        "A quick check makes it obvious what’s missing: ice, real food, bottled water, and spare batteries.",
        "Brian’s sedan is still clear and already facing out. The wagon and the van are boxed in close to the porch."
      ],
      notes: [
        "[AMANDA: Keep it practical. One car leaves, one car stays. Do not let this become an argument about blame.]"
      ],
      choices: [
        { t: "Send Brian with a short list and a time limit.", next: "2.2", fx: (s)=>{ s.normalcy += 1; s.trust += 1; } },
        { t: "Walk Brian to the car and watch the drive until he disappears.", next: "2.2", fx: (s)=>{ s.unease += 1; s.trust += 1; } }
      ],
      hint: "A plan reduces friction, not risk."
    },

    "2.2": {
      title: "After the engine fades",
      loc: "Entryway and living room",
      time: "Dusk",
      text: [
        "Brian’s sedan pulls down the drive. Dust lifts behind it and then settles into the weeds.",
        "The porch light looks brighter now that the sky has dimmed. The curtains still stay closed.",
        "Inside, the radio catches a voice fragment for a second, then returns to static.",
        "A floorboard creaks upstairs. Ashley stops moving and looks toward the staircase."
      ],
      notes: [
        "[AMANDA: Keep Ashley steady. If you chase every sound, you teach the house what works.]"
      ],
      choices: [
        { t: "Go upstairs with Ashley and check the hall together.", next: "2.3", fx: (s)=>{ s.trust += 1; s.unease += 1; } },
        { t: "Keep Ashley downstairs. Listen for a repeat before moving.", next: "2.3", fx: (s)=>{ s.normalcy += 1; s.unease += 1; } }
      ],
      hint: "Movement creates information and mistakes."
    },

    "2.3": {
      title: "A small failure",
      loc: "Kitchen hall",
      time: "Dusk",
      text: [
        "The tape deck hum dips and comes back, then dips again. The red light stays on, but the speakers pop once and go quiet.",
        "The breaker cover labels are easy to read in the hall. One switch sits slightly off alignment compared to the others.",
        "The entry table flashlight is still centered exactly as before. No one admits they noticed.",
        "The radio’s static changes texture when someone steps closer to the front window."
      ],
      notes: [
        "[AMANDA: Fix one thing. Do not fix everything. If you fix everything, you become the only system that matters.]"
      ],
      choices: [
        { t: "Flip the breaker back into alignment and test the tape deck again.", next: "2.4", fx: (s)=>{ s.normalcy += 1; s.unease += 1; s.clues.push({k:'Breaker drift', v:'One labeled switch was slightly out of alignment.'}); } },
        { t: "Leave it alone for now and focus on batteries and light.", next: "2.4", fx: (s)=>{ s.unease += 1; } }
      ],
      hint: "Systems that fail once tend to fail again."
    },

    "2.4": {
      title: "Searching for batteries",
      loc: "Study and utility closet",
      time: "Dusk",
      text: [
        "The study still looks staged: blank notepad aligned, pen aligned, lamp cord coiled. The LIGHTS box is where it was.",
        "The small closet near the kitchen sticks when it opens. The air inside is colder and smells like cardboard and metal.",
        "When the door swings shut, the knob turns but the latch doesn’t pull back cleanly. It holds for a beat too long.",
        "A thin plastic card in your wallet is stiff enough to reach the latch edge if you slide it into the gap."
      ],
      notes: [
        "[AMANDA: Do not panic. Do not make noise that turns this into a crisis. Treat it like a mechanical problem.]"
      ],
      choices: [
        { t: "Search the closet anyway and use the card if it sticks again.", next: "2.5", fx: (s)=>{ s.unease += 1; s.inv.add('Wallet card'); s.clues.push({k:'Sticky latch', v:'A closet latch catches even when the knob turns.'}); } },
        { t: "Stay out of the closet. Take what you can from the LIGHTS box and leave.", next: "2.5", fx: (s)=>{ s.normalcy += 1; s.clues.push({k:'LIGHTS box', v:'Spare bulbs and fuses are staged in the study.'}); } }
      ],
      hint: "If a door misbehaves once, assume it will misbehave again."
    },

    "2.5": {
      title: "What to tell Ashley",
      loc: "Living room",
      time: "Dusk",
      text: [
        "Ashley sits near the couch with her water glass. She keeps looking toward the window and then away again.",
        "The radio spits a clearer fragment for a second. It is still not long enough to understand. Static resumes.",
        "The bucket left a dotted drip trail across the kitchen floor that no one has cleaned yet.",
        "Ashley asks if you saw anything near the well, and her voice stays casual in a way that does not match her face."
      ],
      notes: [
        "[AMANDA: If you tell her, you change her. If you don’t, you change yourself. Pick the option you can live with.]"
      ],
      choices: [
        { t: "Tell her about the silhouette at the tree line.", next: "2.6", fx: (s)=>{ s.trust += 2; s.unease += 1; } },
        { t: "Keep it private. Say you saw nothing useful.", next: "2.6", fx: (s)=>{ s.normalcy += 1; s.unease += 1; } }
      ],
      hint: "Secrecy can be protection or isolation."
    },

    "2.6": {
      title: "Waiting for headlights",
      loc: "Living room and front window",
      time: "Night",
      text: [
        "Outside, the porch light holds steady. The road beyond the clearing is black.",
        "The radio’s static thins for a moment. A voice lands for a full second, then disappears again.",
        "The tape deck stays powered but refuses to feel reliable. The house keeps its own rhythm.",
        "You wait for headlights on the drive and try not to turn waiting into a ritual."
      ],
      notes: [
        "[AMANDA: Stay literal. Do not invent a pattern you can’t prove. Keep the room organized so you can move fast.]"
      ],
      choices: [
        { t: "Continue.", next: "3.1", fx: (s)=>{ 
            s.clues.push({k:'Radio fragment', v:'A longer voice fragment broke through, then fell back to static.'}); 
          } 
        },
        { t: "Replay from 2.1.", next: "2.1", fx: (s)=>{} }
      ],
      hint: "Beat 2 ends before the return."
    },

    "3.1": {
      title: "Headlights and the wrong quiet",
      loc: "Front window and entryway",
      time: "Night",
      text: [
        "Headlights finally sweep the clearing and slide across the porch rail. Gravel crunches. An engine idles for a moment too long before it shuts off.",
        "The front door opens. Brian steps in carrying a plastic bag and a small cardboard box. His face reads tired and alert at the same time.",
        "He sets the bag down on the entry table without moving the centered flashlight. Ice clinks inside the bag. Bottled water knocks together.",
        "He says the store clerk asked questions about the house before selling him batteries, and then pretended the questions were jokes."
      ],
      notes: [
        "[AMANDA: Read Brian’s body first. Do not interrogate him. Let him unload facts in his own order.]",
        "[BRIAN: You brought supplies, but you also brought a new social signal: the town has an opinion about this place.]"
      ],
      choices: [
        { t: "Ask Brian exactly what the clerk said, word for word.", next: "3.2", fx: (s)=>{ s.unease += 1; s.trust += 1; s.inv.add('Ice'); s.inv.add('Bottled water'); s.inv.add('Batteries'); } },
        { t: "Tell Brian to sit, drink water, and start with the batteries.", next: "3.2", fx: (s)=>{ s.normalcy += 1; s.trust += 1; s.inv.add('Ice'); s.inv.add('Bottled water'); s.inv.add('Batteries'); } }
      ],
      hint: "Outside knowledge changes inside behavior."
    },

    "3.2": {
      title: "The clerk’s version",
      loc: "Living room and entryway",
      time: "Night",
      text: [
        "Brian sits on an upside-down box and talks while he opens the small cardboard battery pack. He keeps his voice casual, but he avoids looking toward the staircase.",
        "He says the clerk asked, \"You going up to the old place with the light on,\" and then laughed immediately, like it was a joke he’d told too many times.",
        "Brian says he asked what that meant. The clerk said, \"Nothing. Just don’t drink the well water unless you have to,\" and slid the batteries across the counter without making eye contact.",
        "Scott tries to dismiss it as small-town talk. The radio answers with static and a single thin syllable that almost sounds like a name, then drops out again."
      ],
      notes: [
        "[AMANDA: You take the details, not the tone. You do not argue with Scott. You want a plan for the next hour.]",
        "[SCOTT: You feel judged by a stranger you didn’t meet. You try to erase it with logic.]"
      ],
      choices: [
        { t: "Set a hard rule: nobody goes outside alone until Brian rests.", next: "3.3", fx: (s)=>{ s.trust += 1; s.normalcy += 1; } },
        { t: "Ignore the clerk story and focus on getting music working again.", next: "3.3", fx: (s)=>{ s.normalcy += 1; s.unease += 1; } }
      ],
      hint: "Outside opinions become inside rules."
    },

    "3.3": {
      title: "The batteries test the house",
      loc: "Living room and kitchen",
      time: "Night",
      text: [
        "Amanda opens the battery pack and sets a few cells on the table in a neat line. Scott watches the line like it is an accusation.",
        "The radio takes fresh batteries and behaves the same. Static, then a short voice fragment, then static again.",
        "When the tape deck gets the same treatment, the red power light stays steady, but the speakers pop once and then go quiet for a long beat.",
        "In the kitchen, the faucet still produces nothing. The glass Ashley used sits on the counter with a mineral ring starting to dry."
      ],
      notes: [
        "[AMANDA: You confirm what is stable and what is not. You do not chase the pops. You make a checklist.]"
      ],
      choices: [
        { t: "Follow the sound: go quiet and listen for the next pop or creak.", next: "3.4", fx: (s)=>{ s.unease += 2; } },
        { t: "Make a checklist and assign jobs for ten minutes.", next: "3.4", fx: (s)=>{ s.normalcy += 1; s.trust += 1; s.clues.push({k:'Battery test', v:'Fresh batteries did not stabilize the radio or the tape deck.'}); } }
      ],
      hint: "New inputs do not guarantee new outcomes."
    },

    "3.4": {
      title: "The latch that shouldn’t matter",
      loc: "Kitchen hall and utility closet",
      time: "Night",
      text: [
        "Amanda walks to the small closet near the kitchen and opens it with controlled force. The hinges complain once and stop.",
        "Inside are ordinary maintenance items: a mop, a spare bucket, a small tool box, and a plastic bag holding a replacement doorknob set.",
        "She takes a flashlight from the entry table without comment and keeps the beam low, aimed at the floor and latch edge instead of the corners.",
        "When she pulls the door shut, it closes too cleanly. The knob turns, but the latch doesn’t pull back on the first try.",
        "A thin gap along the latch side is wide enough to slide a stiff card into. The card meets metal. The latch gives after a second of pressure."
      ],
      notes: [
        "[AMANDA: You treat it like a mechanical failure, not a sign. Your hands stay steady. You do not raise your voice.]"
      ],
      choices: [
        { t: "Tell Scott and Ashley about the sticky latch and the replacement knob bag.", next: "3.5", fx: (s)=>{ s.trust += 1; s.normalcy += 1; s.inv.add('Replacement knob set'); s.clues.push({k:'Replacement knob', v:'A new knob set was stored in the closet in a sealed bag.'}); } },
        { t: "Keep it private and put the replacement knob bag somewhere you can reach fast.", next: "3.5", fx: (s)=>{ s.unease += 1; s.inv.add('Replacement knob set'); s.clues.push({k:'Sticky latch', v:'The closet latch held even when the knob turned.'}); } }
      ],
      hint: "Small failures become rules."
    },

    "3.5": {
      title: "A spare part and a rule",
      loc: "Living room",
      time: "Night",
      text: [
        "Amanda returns to the living room with the replacement knob bag in hand. Scott looks at it and tries to make a joke that lands flat.",
        "Ashley watches the bag like it is proof the house expects things to break. She keeps her water close and does not sit back fully.",
        "Brian tests the radio near the front window again. Static fills the room, then a clearer fragment breaks through for a second, almost a full word, then drops out.",
        "The tape deck stays powered. The speakers pop once, then behave as if nothing happened. The room goes quiet around the small sounds.",
        "Amanda sets a rule out loud: nobody closes any interior door all the way unless someone else is within arm’s reach."
      ],
      notes: [
        "[AMANDA: You turn fear into procedure. You do not argue about whether it’s rational. You make it the new normal.]"
      ],
      choices: [
        { t: "Install the replacement knob now, with everyone watching.", next: "3.6", fx: (s)=>{ s.normalcy += 1; s.trust += 1; s.clues.push({k:'Door rule', v:'Nobody closes interior doors fully unless someone is within arm’s reach.'}); s.clues.push({k:'Radio fragment', v:'A clearer fragment almost formed a full word before dropping out.'}); } },
        { t: "Don’t install it yet. Keep the bag visible and focus on keeping people together.", next: "3.6", fx: (s)=>{ s.unease += 1; s.trust += 1; s.clues.push({k:'Door rule', v:'Nobody closes interior doors fully unless someone is within arm’s reach.'}); s.clues.push({k:'Radio fragment', v:'A clearer fragment almost formed a full word before dropping out.'}); } }
      ],
      hint: "Procedures are social glue."
    },

    "3.6": {
      title: "The house answers the rule",
      loc: "Upstairs hall",
      time: "Night",
      text: [
        "A single heavy step sounds upstairs, then another. The rhythm is slow and deliberate, not a stumble.",
        "Amanda and Brian take the flashlight and go up together. Scott follows half a step behind them, keys in his hand. Ashley stays at the bottom of the stairs within sight.",
        "At the top of the hall, one bedroom door is open a few inches more than it was earlier. The gap is small, but it changes the hallway.",
        "The radio static downstairs thins for a moment, and a voice fragment lands clean enough to sound like a warning, then disappears.",
        "When Amanda pushes the bedroom door wider, it swings with no resistance. The room is empty. The window is closed. The air is colder than the hall.",
        "On the floor just inside the doorway, a single fresh scuff mark cuts through dust, as if something heavy was dragged a short distance and then lifted."
      ],
      notes: [
        "[AMANDA: You do not let anyone split off. You do not let Scott go first. You treat the scuff mark as evidence, not a message.]"
      ],
      choices: [
        { t: "Save and stop.", next: null, fx: (s)=>{ s.clues.push({k:'Upstairs scuff', v:'A fresh drag scuff cut through dust just inside an upstairs doorway.'}); s.unease += 1; } },
        { t: "Replay.", next: "3.1", fx: (s)=>{} }
      ],
      hint: "The house reacts to attention."
    },

    "4.1": {
      title: "The tape that shouldn’t be here",
      loc: "Living room",
      time: "Night",
      text: [
        "Everyone returns downstairs together. The radio stays near the front window, still refusing to hold a steady signal.",
        "Brian notices the unlabeled cassette from the under-stairs shelf and holds it up without putting it in yet. The paper sleeve is bent at the corners.",
        "Scott insists the tape deck will make the room feel normal again. Ashley agrees too quickly, like she wants permission to relax.",
        "Amanda checks the tape deck bay and wipes dust off the edge with her thumb. The bay smells faintly metallic and old plastic.",
        "Brian asks the simplest question: none of them brought a cassette. So whose tape is it."
      ],
      notes: [
        "[AMANDA: You do not turn it into a ghost story. You treat it as an object someone left. That still has consequences.]"
      ],
      choices: [
        { t: "Play the cassette at low volume and keep the radio on as a reference.", next: "4.2", fx: (s)=>{ s.unease += 1; s.normalcy += 1; s.clues.push({k:'Unlabeled cassette', v:'No one admits bringing the tape, but it was stored with the radio.'}); } },
        { t: "Do not play it. Bag it and keep it out of the room.", next: "4.2", fx: (s)=>{ s.trust += 1; s.clues.push({k:'Unlabeled cassette', v:'No one admits bringing the tape, but it was stored with the radio.'}); } }
      ],
      hint: "Objects can be bait without being supernatural."
    },

    "4.2": {
      title: "Sound makes the room smaller",
      loc: "Living room",
      time: "Night",
      text: [
        "If the cassette plays, it starts with a blank stretch: hiss, then a low tone that could be music or could be tape damage.",
        "If the cassette is bagged instead, the tape deck stays on with no tape, and the room fills with a thin mechanical hum and occasional speaker pop.",
        "The radio catches a clearer phrase for a moment. It is still not a full sentence, but it sounds directed. Then static returns.",
        "Scott moves closer to the front window as if proximity will solve reception. Ashley stays close to the couch, watching hands and doors.",
        "Amanda notices the entry table flashlight is no longer perfectly parallel to the table edge. It has shifted by a few degrees."
      ],
      notes: [
        "[AMANDA: You do not announce the flashlight shift as proof. You watch who reacts first.]"
      ],
      choices: [
        { t: "Quietly re-center the flashlight and say nothing.", next: "4.3", fx: (s)=>{ s.unease += 1; s.clues.push({k:'Flashlight shift', v:'The entry table flashlight rotated slightly without anyone claiming it.'}); } },
        { t: "Ask, casually, who touched the flashlight.", next: "4.3", fx: (s)=>{ s.trust += 1; s.unease += 1; s.clues.push({k:'Flashlight shift', v:'The entry table flashlight rotated slightly without anyone claiming it.'}); } }
      ],
      hint: "Small changes test group honesty."
    },

    "4.3": {
      title: "The first direct message",
      loc: "Front window and living room",
      time: "Night",
      text: [
        "The radio holds a signal for longer than before. The static thins, and a voice lands clean enough to understand a short phrase.",
        "The phrase repeats once, slightly distorted, then the signal collapses back into hiss.",
        "Brian says the phrase out loud to confirm he heard it. Scott goes quiet. Ashley’s hand tightens around her glass.",
        "The tape deck either continues its low hum or the cassette continues its damaged tone, but all of it feels secondary for a moment."
      ],
      notes: [
        "[AMANDA: You keep your face neutral so nobody feeds off your reaction. You focus on what was said and what it implies for movement.]"
      ],
      choices: [
        { t: "Write the phrase down and treat it as a direction.", next: "4.4", fx: (s)=>{ s.clues.push({k:'Radio phrase', v:'A short phrase came through clearly and repeated once.'}); s.unease += 1; } },
        { t: "Assume it’s random interference and refuse to act on it.", next: "4.4", fx: (s)=>{ s.normalcy += 1; s.unease += 1; s.clues.push({k:'Radio phrase', v:'A short phrase came through clearly and repeated once.'}); } }
      ],
      hint: "Once a message is understood, ignoring it becomes a choice."
    },

    "4.4": {
      title: "A test of togetherness",
      loc: "Kitchen and upstairs landing",
      time: "Night",
      text: [
        "Amanda proposes a simple rule: no one moves alone, and no one closes a door fully behind them.",
        "Scott agrees too fast, then immediately tries to take charge of the route, as if route choice restores authority.",
        "Ashley asks to use the bathroom. The hallway upstairs is narrow and the runner shifts at the edges underfoot.",
        "Brian offers to go with her and stand in the hall. The radio hisses downstairs as if it is listening."
      ],
      notes: [
        "[AMANDA: You are managing bodies, not fear. You keep it logistical so it stays believable.]"
      ],
      choices: [
        { t: "Go upstairs as a group and keep the flashlight low.", next: "4.5", fx: (s)=>{ s.trust += 1; s.unease += 1; } },
        { t: "Let Brian escort Ashley while you and Scott stay downstairs with the radio.", next: "4.5", fx: (s)=>{ s.unease += 2; } }
      ],
      hint: "Rules only matter when someone needs something."
    },

    "4.5": {
      title: "The bathroom door",
      loc: "Upstairs hall",
      time: "Night",
      text: [
        "The upstairs hall is lit by the flashlight beam and a harsh ceiling bulb. The runner shifts slightly when a foot lands near the edge.",
        "The bathroom door is slightly misaligned in its frame. The knob turns normally, but the latch sounds louder than it should when it clears.",
        "Ashley goes in. Brian stays in the hall. If the group came up together, everyone holds position and keeps eyes on the doors.",
        "The radio downstairs produces a burst of static that rises and falls in a slow curve, then stops suddenly.",
        "From inside the bathroom, the faucet handle turns. Nothing comes out. Then the toilet tank gives a short refill sound that should not be possible."
      ],
      notes: [
        "[AMANDA: You do not argue about what you heard. You focus on the sequence: handle, silence, refill sound. Sequence is evidence.]"
      ],
      choices: [
        { t: "Open the bathroom door immediately and keep it from closing fully.", next: "4.6", fx: (s)=>{ s.trust += 1; s.unease += 1; s.clues.push({k:'Bathroom sound', v:'A refill sound occurred after a dry faucet turn.'}); } },
        { t: "Wait for Ashley to speak first before touching the door.", next: "4.6", fx: (s)=>{ s.unease += 2; s.clues.push({k:'Bathroom sound', v:'A refill sound occurred after a dry faucet turn.'}); } }
      ],
      hint: "Systems behave differently when no one is watching."
    },

    "4.6": {
      title: "A small proof, a bigger problem",
      loc: "Upstairs hall and stairs",
      time: "Night",
      text: [
        "Ashley exits the bathroom looking relieved and unsettled at the same time. She says the toilet refilled, but the sink stayed dry.",
        "Scott tries to treat it as good news. Brian does not agree or disagree. He just watches the hallway and keeps the flashlight steady.",
        "On the way back down, the runner shifts again. A soft scraping sound comes from the closed spare room door as if something brushed the floor on the other side.",
        "When everyone stops, the scraping stops. When someone takes one step, it starts again, then stops abruptly.",
        "Downstairs, the radio catches the same short phrase again, clearer this time, then drops into a long static hiss."
      ],
      notes: [
        "[AMANDA: You now have repeatable audio and a repeatable response upstairs. You do not call it supernatural. You call it pattern.]"
      ],
      choices: [
        { t: "End Beat 4. Save and stop.", next: null, fx: (s)=>{ s.clues.push({k:'Repeat pattern', v:'Scraping upstairs responded to movement and stopped when watched.'}); s.unease += 1; } },
        { t: "Continue to Beat 5.1.", next: "5.1", fx: (s)=>{ s.clues.push({k:'Repeat pattern', v:'Scraping upstairs responded to movement and stopped when watched.'}); s.unease += 1; } }
      ],
      hint: "Once a pattern repeats, denial costs more."
    },

    "5.1": {
      title: "The house starts assigning",
      loc: "Living room and kitchen",
      time: "Night",
      text: [
        "Amanda lays items out on the table: batteries, the replacement knob bag, the note with the code, and the folded clipping.",
        "Scott stares at the clipping and asks why she didn’t mention it earlier. Ashley says she doesn’t want to hear about missing kids at night.",
        "The radio gives a clearer phrase again, and this time the final word sounds like a room name or a direction inside the house.",
        "Brian suggests they treat the radio like a checklist and verify what it references without splitting up.",
        "The tape deck pops once, and the porch light outside flickers just enough to be noticed."
      ],
      notes: [
        "[AMANDA: You are done improvising. You want a controlled test: one instruction, one response, one observation.]"
      ],
      choices: [
        { t: "Follow the radio phrase as a direction and move as a group.", next: "5.2", fx: (s)=>{ s.trust += 1; s.unease += 1; s.clues.push({k:'Radio direction', v:'The phrase ended with a word that sounded like a location.'}); } },
        { t: "Refuse to follow it and instead secure doors and windows first.", next: "5.2", fx: (s)=>{ s.normalcy += 1; s.unease += 1; } }
      ],
      hint: "At some point, a choice becomes a test."
    },

    "5.2": {
      title: "One instruction, one check",
      loc: "Center hall and study",
      time: "Night",
      text: [
        "Amanda keeps the radio on low and repeats the last phrase out loud once, the way you repeat a phone number before you forget it.",
        "The group moves together into the hall. Nobody closes any door fully behind them. The flashlight beam stays low, aimed at the floor and latch edges.",
        "They stop at the study and open it. The room still looks staged, but one thing has changed: the pen is no longer perfectly parallel to the notepad.",
        "The top page of the notepad is no longer blank. A single line has been written in block letters, centered on the page.",
        "The line matches one word from the radio phrase. The ink looks fresh."
      ],
      notes: [
        "[AMANDA: You do not debate how it got there. You treat it as a test condition: new information appeared after the phrase repeated.]"
      ],
      choices: [
        { t: "Log the exact word and the pen angle, then back out and end here.", next: "5.3", fx: (s)=>{ s.trust += 1; s.unease += 1; s.clues.push({k:'Study note', v:'A new line appeared on the notepad and matched a word from the radio.'}); } },
        { t: "Touch the ink with a fingertip to confirm it’s fresh, then end here.", next: "5.3", fx: (s)=>{ s.unease += 2; s.clues.push({k:'Fresh ink', v:'Ink on the study notepad felt fresh to the touch.'}); } }
      ],
      hint: "A controlled test produced a change."
    },

    "5.3": {
      title: "The second line",
      loc: "Study and hall",
      time: "Night",
      text: [
        "The group returns to the study together. The room still looks staged, but the notepad now has a second line beneath the first.",
        "The new line is centered and written in the same block style as before. The pen is angled a few degrees differently than it was.",
        "The radio downstairs pushes through static and lands on a short phrase that includes the same key word from the page, then drops out again.",
        "Scott insists it could be coincidence. Brian says coincidence is still data if it repeats."
      ],
      notes: [
        "[AMANDA: You keep it procedural. You want one more controlled check before anyone spirals.]"
      ],
      choices: [
        { t: "Write down both lines and the radio phrase, then test the next location as a group.", next: "5.4", fx: (s)=>{ s.trust += 1; s.unease += 1; s.clues.push({k:'Second line', v:'A second line appeared on the notepad and matched part of the radio phrase.'}); } },
        { t: "Stop testing. Move back to the living room and focus on safety rules only.", next: "5.4", fx: (s)=>{ s.normalcy += 1; s.unease += 1; s.clues.push({k:'Second line', v:'A second line appeared on the notepad and matched part of the radio phrase.'}); } }
      ],
      hint: "A repeatable change creates obligations."
    },

    "5.4": {
      title: "The latch proves the point",
      loc: "Kitchen hall",
      time: "Night",
      text: [
        "Amanda leads the group to the small closet near the kitchen. The flashlight stays low, aimed at the floor and the latch edge.",
        "The door opens with a sticky hinge sound. Inside are ordinary maintenance items and a sealed bag holding a replacement doorknob set.",
        "When the door swings shut, it closes too cleanly. The knob turns, but the latch does not pull back on the first try.",
        "Amanda slides a stiff card into the latch gap and applies steady pressure. The latch gives after a second, and the door opens again.",
        "Brian says it out loud: if anyone was alone, that would have been a trap even if it is only carpentry."
      ],
      notes: [
        "[AMANDA: You keep your voice calm. You treat it as mechanics, but you do not minimize the consequence.]"
      ],
      choices: [
        { t: "Use the screwdriver from the LIGHTS box to tighten the latch plate screws.", next: "5.5", fx: (s)=>{ s.normalcy += 1; s.inv.add('Screwdriver'); s.clues.push({k:'Latch catch', v:'The latch failed once even with the knob turning. A stiff card freed it.'}); } },
        { t: "Do not “fix” it. Treat it as a hazard and keep it propped open.", next: "5.5", fx: (s)=>{ s.unease += 1; s.inv.add('Replacement knob set'); s.clues.push({k:'Latch catch', v:'The latch failed once even with the knob turning. A stiff card freed it.'}); } }
      ],
      hint: "Fixing a hazard can remove warning signs."
    },

    "5.5": {
      title: "The well warning lands",
      loc: "Living room",
      time: "Night",
      text: [
        "Back in the living room, the radio holds a clearer signal for two full seconds. The phrase includes the word basement this time, then collapses into static.",
        "Brian repeats what the clerk said: do not drink the well water unless you have to. Ashley sets her glass down and stops pretending she is fine.",
        "Scott argues that the basement is optional. Amanda points out that an optional basement becomes necessary when the house won’t run water any other way.",
        "The tape deck pops once, then stays quiet, as if it is waiting for a decision."
      ],
      notes: [
        "[AMANDA: You are not chasing horror. You are chasing function. Function forces movement.]"
      ],
      choices: [
        { t: "Stage a controlled descent: flashlight, screwdriver, and the door rule.", next: "5.6", fx: (s)=>{ s.trust += 1; s.unease += 1; s.clues.push({k:'Basement word', v:'The radio phrase included the word basement clearly.'}); } },
        { t: "Refuse to go down tonight. Barricade and wait for morning.", next: "5.6", fx: (s)=>{ s.normalcy += 1; s.unease += 2; s.clues.push({k:'Basement word', v:'The radio phrase included the word basement clearly.'}); } }
      ],
      hint: "Avoidance is also a plan."
    },

    "5.6": {
      title: "At the basement door",
      loc: "Center hall",
      time: "Night",
      text: [
        "The basement door sits in the hall with darker paint and a cooler seam. The air near it feels different than the rest of the house.",
        "Amanda keeps everyone within arm’s reach. Scott keeps his keys in his hand, not because he needs them, because holding them makes him steadier.",
        "The flashlight beam catches scuffs on the floor near the threshold, old marks from something dragged long ago.",
        "From downstairs, past the door, there is no sound. The house stays quiet enough to make listening feel like work."
      ],
      notes: [
        "[AMANDA: You do not open the door yet. You end the beat with preparation, not action.]"
      ],
      choices: [
        { t: "Continue.", next: "6.1", fx: (s)=>{ s.clues.push({k:'Basement threshold', v:'Cool air at the seam and old drag scuffs near the threshold.'}); } },
        { t: "Replay from 5.3.", next: "5.3", fx: (s)=>{} }
      ],
      hint: "Preparation changes the outcome more than courage."
    },

    "6.1": {
      title: "First step down",
      loc: "Basement stairs",
      time: "Late night",
      text: [
        "Amanda opens the basement door and holds it. The air that comes up is cooler and smells like concrete and old metal.",
        "Brian takes the flashlight. The beam stays low on the steps. Scott keeps one hand on the rail. Ashley stays at the top of the stairs within sight.",
        "The first few steps are concrete with grit embedded in the surface. The handrail finish is worn where hands have gripped in the past.",
        "Halfway down, the radio upstairs briefly clears and the same short phrase lands again, then drops back into static."
      ],
      notes: [
        "[AMANDA: Move slow. Keep spacing tight. If someone needs to step back, the door stays open.]"
      ],
      choices: [
        { t: "Continue down. Keep the door propped and the group in one line.", next: "6.2", fx: (s)=>{ s.unease += 1; s.trust += 1; } },
        { t: "Stop at the landing and listen for a repeat before taking another step.", next: "6.2", fx: (s)=>{ s.unease += 1; s.normalcy += 1; } }
      ],
      hint: "A descent is a procedure, not a dare."
    },

    "6.2": {
      title: "The pump corner",
      loc: "Basement utility area",
      time: "Late night",
      text: [
        "The flashlight finds a utility corner: a pressure tank, a pump housing, and a shutoff valve with mineral staining around the fittings.",
        "A thin drip line runs down the concrete wall beneath the valve, old and dry. A bucket sits under it anyway, empty.",
        "A breaker box label is taped to a beam: PUMP. It is handwritten in the same thick marker style as the storage labels upstairs.",
        "Brian touches the valve handle. It is already in the open position."
      ],
      notes: [
        "[AMANDA: You do not yank anything. You confirm states first: on or off, open or closed, wet or dry.]"
      ],
      choices: [
        { t: "Check the pump power label and trace the wire run with the flashlight.", next: "6.3", fx: (s)=>{ s.clues.push({k:'Pump label', v:'A handwritten PUMP label is taped to a beam near the utility corner.'}); s.unease += 1; } },
        { t: "Test the pump switch once, then stop and listen for changes upstairs.", next: "6.3", fx: (s)=>{ s.normalcy += 1; s.unease += 1; s.clues.push({k:'Pump test', v:'A single controlled pump test was attempted.'}); } }
      ],
      hint: "If someone staged the house, they staged this too."
    },

    "6.3": {
      title: "The missing piece",
      loc: "Basement storage nook",
      time: "Late night",
      text: [
        "A short hallway off the utility corner ends at a small interior door. The door is closed. The knob turns, but the latch catches for a beat before it releases.",
        "Inside is a storage nook with shelving and dust. On the floor is a clean rectangle where something heavy sat recently.",
        "A length of hose lies coiled on a lower shelf. The end fitting is wet, as if it was used and put away.",
        "On a nail above the clean rectangle hangs a ring of old keys. One key is missing from the ring."
      ],
      notes: [
        "[AMANDA: You do not touch the keys first. You scan for what changed: clean rectangle, wet fitting, missing key.]"
      ],
      choices: [
        { t: "Log the missing key ring and take the wet hose as evidence.", next: "6.4", fx: (s)=>{ s.inv.add('Hose (wet fitting)'); s.clues.push({k:'Missing key ring', v:'An old key ring hangs in the basement storage nook with one key missing.'}); s.unease += 1; } },
        { t: "Leave everything in place and back out slowly, keeping the door from closing fully.", next: "6.4", fx: (s)=>{ s.trust += 1; s.clues.push({k:'Clean rectangle', v:'A clean rectangle in dust suggests a heavy object was removed recently.'}); s.unease += 1; } }
      ],
      hint: "Evidence can be moved or recorded."
    },

    "6.4": {
      title: "Upstairs response",
      loc: "Stairs and living room",
      time: "Late night",
      text: [
        "As the group returns to the stairs, the house responds upstairs: a soft scrape across the floor, then silence.",
        "When Brian takes one step up, the scrape repeats once, then stops as soon as he pauses.",
        "Back in the living room, the faucet in the kitchen gives a single drip. One drip only. Then nothing.",
        "The radio hisses, then a short phrase lands cleanly enough to understand one new word: stop."
      ],
      notes: [
        "[AMANDA: You have a pattern and a new word. You do not treat it as a command yet. You treat it as a data point.]"
      ],
      choices: [
        { t: "End here. Save and stop.", next: null, fx: (s)=>{ s.clues.push({k:'One drip', v:'The kitchen faucet produced exactly one drip after the basement check.'}); s.clues.push({k:'Radio word', v:'The radio delivered one clear word: stop.'}); } },
        { t: "Continue to Beat 7.1.", next: null, fx: (s)=>{ s.clues.push({k:'One drip', v:'The kitchen faucet produced exactly one drip after the basement check.'}); s.clues.push({k:'Radio word', v:'The radio delivered one clear word: stop.'}); } }
      ],
      hint: "The house gives partial compliance."
    }
  };

  function validateBeats() {
    const beatKeys = Object.keys(beats);
    for (const key of beatKeys) {
      const beat = beats[key];
      if (!beat || typeof beat !== 'object') {
        throw new Error(`Beat "${key}" is not a valid object.`);
      }
      if (!beat.choices || !Array.isArray(beat.choices)) {
        throw new Error(`Beat "${key}" has no choices array.`);
      }
      if (beat.choices.length < 2 && !beat.choices.some(c => c.next === null)) {
        throw new Error(`Beat "${key}" has ${beat.choices.length} choices and no end choice (next: null).`);
      }
      for (const choice of beat.choices) {
        if (choice.next !== null && !(choice.next in beats)) {
          throw new Error(`Beat "${key}" choice next "${choice.next}" does not exist.`);
        }
      }
    }
  }

  function escapeHtml(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  let twTimer = null;
  function typewrite(el, html){
    if (twTimer) { clearInterval(twTimer); twTimer = null; }
    el.innerHTML = "";
    const chunks = html.split(/(<[^>]+>)/g).filter(Boolean);
    let i = 0;
    twTimer = setInterval(() => {
      el.innerHTML += chunks[i] || "";
      i += 1;
      if (i >= chunks.length) { clearInterval(twTimer); twTimer = null; }
    }, 18);
  }

  function renderInv(){
    const inv = $("invList");
    inv.innerHTML = "";
    const items = Array.from(state.inv.values()).sort();
    if (!items.length){
      const t = document.createElement("span");
      t.className = "tag";
      t.textContent = "Empty";
      inv.appendChild(t);
      return;
    }
    items.forEach((it) => {
      const tag = document.createElement("span");
      tag.className = "tag ok";
      tag.textContent = it;
      inv.appendChild(tag);
    });
  }

  function renderJournal(){
    const j = $("journal");
    j.innerHTML = "";
    if (!state.clues.length){
      j.innerHTML = '<div class="item">No clues logged yet.</div>';
      return;
    }
    const last = state.clues.slice(-8);
    last.forEach((c) => {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = "<b>" + escapeHtml(c.k) + "</b><div>" + escapeHtml(c.v) + "</div>";
      j.appendChild(div);
    });
  }

  function renderChoices(choices){
    const row = $("choiceRow");
    row.innerHTML = "";
    choices.forEach((c) => {
      const btn = document.createElement("button");
      btn.className = "btn primary choice";
      btn.textContent = c.t;
      btn.onclick = () => advance(c);
      row.appendChild(btn);
    });
  }

  function render(){
    const b = beats[state.beat];
    $("beatPill").textContent = "Beat " + state.beat;
    $("locPill").textContent = b.loc;
    state.time = b.time;
    $("timeVal").textContent = state.time;
    $("trustVal").textContent = String(state.trust);
    $("normVal").textContent = String(state.normalcy);
    $("uneaseVal").textContent = String(state.unease);
    $("sceneTitle").textContent = b.title;
    $("hintText").textContent = b.hint || "";

    const blocks = [];
    b.text.forEach((p) => blocks.push("<p>" + escapeHtml(p) + "</p>"));
    if (state.showNotes && b.notes && b.notes.length){
      const n = b.notes.map(escapeHtml).join("<br>");
      blocks.push('<div class="thoughts">' + n + "</div>");
    }
    const el = $("sceneText");
    if (!state.typewriter) el.innerHTML = blocks.join("");
    else typewrite(el, blocks.join(""));

    renderChoices(b.choices || []);
    renderInv();
    renderJournal();
  }

  function advance(choice){
    if (typeof choice.fx === "function") choice.fx(state);
    if (!choice.next) { render(); return; }
    state.beat = choice.next;
    render();
  }

  const SAVE_KEY = "fixing_house_beat1_save_v1";
  function save(){
    const payload = {
      beat: state.beat, showNotes: state.showNotes, typewriter: state.typewriter,
      trust: state.trust, normalcy: state.normalcy, unease: state.unease, time: state.time,
      inv: Array.from(state.inv.values()), clues: state.clues, flags: state.flags
    };
    localStorage.setItem(SAVE_KEY, JSON.stringify(payload));
  }
  function load(){
    const raw = localStorage.getItem(SAVE_KEY);
    if (!raw) return false;
    const p = JSON.parse(raw);
    state.beat = p.beat || "1.1";
    state.showNotes = !!p.showNotes;
    state.typewriter = p.typewriter !== false;
    state.trust = Number(p.trust || 0);
    state.normalcy = Number(p.normalcy || 0);
    state.unease = Number(p.unease || 0);
    state.time = p.time || "Late afternoon";
    state.inv = new Set(p.inv || []);
    state.clues = Array.isArray(p.clues) ? p.clues : [];
    state.flags = p.flags || state.flags;
    return true;
  }
  function resetSave(){ localStorage.removeItem(SAVE_KEY); }

  function flash(msg){
    const h = $("hintText");
    const old = h.textContent;
    h.textContent = msg;
    setTimeout(()=>{ h.textContent = old; }, 900);
  }

  $("btnToggleNotes").onclick = () => {
    state.showNotes = !state.showNotes;
    $("btnToggleNotes").textContent = "Actor notes: " + (state.showNotes ? "on" : "off");
    render();
  };
  $("btnToggleType").onclick = () => {
    state.typewriter = !state.typewriter;
    $("btnToggleType").textContent = "Typewriter: " + (state.typewriter ? "on" : "off");
    render();
  };
  $("btnSave").onclick = () => { save(); flash("Saved."); };
  $("btnLoad").onclick = () => { flash(load() ? "Loaded." : "No save found."); render(); };
  $("btnReset").onclick = () => { resetSave(); flash("Save reset."); };
  $("btnNew").onclick = () => { resetSave(); load(); state.beat="1.1"; state.trust=0; state.normalcy=0; state.unease=0; state.inv=new Set(); state.clues=[]; state.flags.gotPliers=true; render(); };

  $("btnBeatReplay").onclick = () => { render(); flash("Replayed."); };
  $("btnBeatSaveStop").onclick = () => { save(); flash("Saved. Close the tab to stop."); };

  load();
  validateBeats();
  $("btnToggleNotes").textContent = "Actor notes: " + (state.showNotes ? "on" : "off");
  $("btnToggleType").textContent = "Typewriter: " + (state.typewriter ? "on" : "off");
  render();
})();
</script>
</body>
</html>
